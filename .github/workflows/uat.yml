name: CI/CD UAT

on:
  push:
    branches: ["uat"]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME_UAT }}
  K8S_NAMESPACE: ${{ secrets.K8S_NAMESPACE_UAT }}

jobs:
  test_and_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run unit tests
        run: |
          pytest -q tests/unit
      # Integration tests skipped in UAT mock CI
      - name: Mock Sonar scan (UAT)
        run: |
          echo "[MOCK] SonarQube scan skipped on UAT (no secrets)"
      # Optional real Sonar scan removed in mock mode

  build_and_push:
    runs-on: ubuntu-latest
    needs: [test_and_scan]
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Mock build and push
        run: |
          echo "[MOCK] Building Docker image"
          docker build -t smart-feedback-service:uat-${{ github.sha }} .
          echo "[MOCK] Pushing image to ECR skipped"
      - name: Mock image scan
        run: |
          echo "[MOCK] Trivy image scan passed"

  deploy_eks:
    runs-on: ubuntu-latest
    needs: [build_and_push]
    steps:
      - uses: actions/checkout@v4
      - name: Mock deploy to EKS
        run: |
          echo "[MOCK] Applying Kubernetes manifests"
          echo "[MOCK] Rollout successful"

  post_deploy_tests:
    runs-on: ubuntu-latest
    needs: [deploy_eks]
    steps:
      - name: Mock post-deploy tests
        run: |
          echo "[MOCK] Cluster smoke test passed"
          echo "[MOCK] UAT ingress non-public check passed"

  rollback_on_failure:
    runs-on: ubuntu-latest
    needs: [post_deploy_tests]
    if: failure()
    steps:
      - name: Mock rollback
        run: |
          echo "[MOCK] Rollback performed"
